#!/bin/sh
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# linkhandler - Universal, Cross-Platform URL Dispatcher for Newsboat
#
# This script inspects a given URL and opens it with the most appropriate
# application. It is designed to work on both Linux (Wayland/X11) and macOS.
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Ensure a URL was provided as an argument.
if [ -z "$1" ]; then
  echo "Usage: $(basename "$0") <URL>"
  exit 1
fi

url="$1"

# --- URL Routing Logic ---
# The patterns are checked in order. The first match executes and exits.
case "$url" in
# Video streaming sites -> open with mpv (detached)
*youtube.com* | *youtu.be* | *vimeo.com* | *twitch.tv* | *peertube.*)
  nohup mpv "$url" >/dev/null 2>&1 &
  disown
  ;;

# Image file extensions -> open with a native image viewer
*.jpg | *.jpeg | *.png | *.gif | *.webp)
  case "$(uname -s)" in
  Darwin*) # On macOS, use the 'open' command
    open "$url"
    ;;
  *) # On Linux, use a Wayland-native viewer like swayimg
    nohup swayimg "$url" >/dev/null 2>&1 &
    disown
    ;;
  esac
  ;;

# Audio file extensions -> open with mpv (no video window, detached)
*.mp3 | *.flac | *.ogg | *.opus)
  nohup mpv --no-video "$url" >/dev/null 2>&1 &
  disown
  ;;

# Default case for all other URLs -> open in the system's default browser.
*)
  case "$(uname -s)" in
  Darwin*) open "$url" ;;
  *) xdg-open "$url" ;;
  esac
  ;;
esac
